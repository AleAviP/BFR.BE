######SPARSE#####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset01.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset02.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset03.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset04.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset05.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset06.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset07.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset08.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset09.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1000q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1000q10NBDataset10.RData")

######1500####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset01.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset02.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset03.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset04.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset05.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset06.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset07.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset08.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset09.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p1500q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p1500q10NBDataset10.RData")

######FIX#####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset01.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset02.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset03.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset04.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset05.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset06.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset07.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset08.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset09.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset10.RData")

######1500####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset01.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset02.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset03.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset04.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset05.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset06.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset07.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset08.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset09.RData")
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Veronikas/FA_CODE/FACTOR_CODE_update.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Plots_programs/plots_FA_V4.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.0007548266,0.7548265546,length.out=10))
fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1500*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1500*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset10.RData")

######FIXING FastBFA Table####
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset01.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset01.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset02.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset02.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset03.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset03.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset04.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset04.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset05.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset05.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset06.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset06.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset07.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset07.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset08.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset08.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset09.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset09.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset10.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1000q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1000q10NBDataset10.RData")

#####15000####
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset01.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset01.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset02.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset02.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset03.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset03.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset04.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset04.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset05.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset05.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset06.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset06.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset07.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset07.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset08.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset08.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset09.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset09.RData")

load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset10.RData")

q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   Laplace_S=sum(apply(resultLaplace_100$P_star>0.5,2,sum)!=0),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   Laplace_NS=sum(apply(resultLaplace_10$P_star>0.5,2,sum)!=0),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=1000*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   Laplace_S=sum(resultLaplace_100$P_star>0.5),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=1000*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   Laplace_NS=sum(resultLaplace_10$P_star>0.5),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,Omega,B),
                Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),Omega,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),Omega,B)),
                MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),Omega,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),Omega,B)),
                #Laplace_S=FNorm(resultLaplace_100$Omega,PostML(resultLaplace_100),Omega,B),
                Laplace_S=FNorm(resultLaplace_100$Omega,resultLaplace_100$B,Omega,B),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,Omega,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,Omega,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,Omega,B),
                Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),Omega,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),Omega,B)),
                MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),Omega,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),Omega,B)),
                Laplace_NS=FNorm(resultLaplace_10$Omega,resultLaplace_10$B,Omega,B),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,Omega,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,Omega,B))


FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nrW,fnNormal100rW)<=min(fnNormal100nrjkW,fnNormal100rjkW),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nrW,fnMOM100rW)<=min(fnMOM100nrjkW,fnMOM100rjkW),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               Laplace_S=FNorm2(resultLaplace_100$sigma,resultLaplace_100$B,Sigma),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nrW,fnNormal10rW)<=min(fnNormal10nrjkW,fnNormal10rjkW),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nrW,fnMOM10rW)<=min(fnMOM10nrjkW,fnMOM10rjkW),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               Laplace_NS=FNorm2(resultLaplace_10$sigma,resultLaplace_10$B,Sigma),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              Laplace_S=resultLaplace_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              Laplace_NS=resultLaplace_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN4=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_covX=FN2,it=it)
round(t(tableFN4),1)
write.csv(round(t(tableFN4),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p1500q10NBv2Dataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p1500q10NBDataset10.RData")
