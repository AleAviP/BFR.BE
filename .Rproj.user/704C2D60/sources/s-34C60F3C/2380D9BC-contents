######250####
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Paper1806/1806FixMn100p250q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset01.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset02.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset03.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset04.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset05.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset06.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset07.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset08.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset09.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset10.RData")

######500####
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset01.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset02.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset03.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset04.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset05.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset06.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset07.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset08.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset09.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset10.RData")

######Sparse####
######250####
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset01.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset02.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset03.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset04.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset05.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset06.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset07.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset08.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset09.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset10.RData")

######500####
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(123)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset01.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(124)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset02.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(125)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset03.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(126)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset04.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(127)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset05.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(128)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset06.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(129)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset07.RData")

###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(130)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset08.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(131)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=norm((COMBAT_100$Gamma%*%t(COMBAT_100$Gamma)+diag(COMBAT_100$Sigma))-(Sigma),type ="F"),
               FastBFA_S=FNorm2(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=norm((COMBAT_10$Gamma%*%t(COMBAT_10$Gamma)+diag(COMBAT_10$Sigma))-(Sigma),type ="F"),
               FastBFA_NS=FNorm2(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset09.RData")
###1
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/faNPD.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

set.seed(132)
rho.aux=as.matrix(seq(0.2,0.75,length.out=6))
rho.aux.1=as.matrix(seq(0.0075,0.75,length.out=10))

fit_lasso_10<- fanc(Y,factors=10,rho=rho.aux.1,gamma=Inf)
fit_lasso_100<- fanc(Y,factors=100,rho=rho.aux,gamma=Inf)

model_lasso_10<-select(fit_lasso_10, criterion="BIC", gamma=Inf)
model_lasso_100<-select(fit_lasso_100, criterion="BIC", gamma=Inf)

model_lasso_10.Ez=E.Z(Y,as.matrix(model_lasso_10$loadings),model_lasso_10$uniquenesses,diag(10))$z
model_lasso_100.Ez=E.Z(Y,as.matrix(model_lasso_100$loadings),model_lasso_100$uniquenesses,diag(100))$z

COMBAT_10 = fa.em(t(COMBAT),10,tol=0.001, maxiter = 100)
COMBAT_100 = fa.em(t(COMBAT),100,tol=0.001, maxiter = 100)


q.hat.2=data.frame(Flat_S=sum(resultFlat_100$gTheta!=0),
                   Normal_S=sum(apply(Normal_100$gamma>0.5,2,sum)!=0),
                   MOM_S=sum(apply(MOM_100$gamma>0.5,2,sum)!=0),
                   COMBAT_S=ncol(COMBAT_100$Gamma),
                   FastBFA_S=sum(apply(resultLaplace_100_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_S=sum(apply(model_lasso_100$loadings,2,sum)!=0),
                   Flat_NS=sum(resultFlat_10$gTheta!=0),
                   Normal_NS=sum(apply(Normal_10$gamma>0.5,2,sum)!=0),
                   MOM_NS=sum(apply(MOM_10$gamma>0.5,2,sum)!=0),
                   COMBAT_NS=ncol(COMBAT_10$Gamma),
                   FastBFA_NS=sum(apply(resultLaplace_10_Vl20$P_star>0.5,2,sum)!=0),
                   Lasso_NS=sum(apply(model_lasso_10$loadings,2,sum)!=0))

m.hat.2=data.frame(Flat_S=250*100,
                   Normal_S=sum(Normal_100$gamma>0.5),
                   MOM_S=sum(MOM_100$gamma>0.5),
                   COMBAT_S= length(COMBAT_100$Gamma),
                   FastBFA_S=sum(resultLaplace_100_Vl20$P_star),
                   Lasso_S=sum(apply(model_lasso_100$loadings!=0,2,sum)),
                   Flat_NS=250*10,
                   Normal_NS=sum(Normal_10$gamma>0.5),
                   MOM_NS=sum(MOM_10$gamma>0.5),
                   COMBAT_NS=length(COMBAT_10$Gamma),
                   FastBFA_NS=sum(resultLaplace_10_Vl20$P_star),
                   Lasso_NS=sum(apply(model_lasso_10$loadings!=0,2,sum)))

FN.2=data.frame(Flat_S=FNorm(resultFlat_100$Ez,resultFlat_100$M,X,B),
                Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                                FNorm(Normal_100$Ez,PostM2(Normal_100),X,B),
                                FNorm(Normal_100$Ez,PostM(Normal_100),X,B)),
                MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                             FNorm(MOM_100$Ez,PostM2(MOM_100),X,B),
                             FNorm(MOM_100$Ez,PostM(MOM_100),X,B)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,resultLaplace_100_Vl20$B,X,B),
                Lasso_S=FNorm(model_lasso_100.Ez,model_lasso_100$loadings,X,B),
                Flat_NS=FNorm(resultFlat_10$Ez,resultFlat_10$M,X,B),
                Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                 FNorm(Normal_10$Ez,PostM2(Normal_10),X,B),
                                 FNorm(Normal_10$Ez,PostM(Normal_10),X,B)),
                MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                              FNorm(MOM_10$Ez,PostM2(MOM_10),X,B),
                              FNorm(MOM_10$Ez,PostM(MOM_10),X,B)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-X%*%t(B),type ="F"),
                #FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,PostML(resultLaplace_10_Vl20),Omega,B),
                FastBFA_NS=FNorm(resultLaplace_10_Vl20$Omega,resultLaplace_10_Vl20$B,X,B),
                Lasso_NS=FNorm(model_lasso_10.Ez,model_lasso_10$loadings,X,B))

FN.x=data.frame(Flat_S=FNormXhat(resultFlat_100,X,W,Z,Theta,Beta,B),
                Normal_S=FNormXhat(Normal_100,X,W,Z,Theta,Beta,B,
                                   min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk)),
                MOM_S=FNormXhat(MOM_100,X,W,Z,Theta,Beta,B,
                                min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk)),
                COMBAT_S=norm(COMBAT_100$Z%*%t(COMBAT_100$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_S=norm(resultLaplace_100_Vl20$Omega%*%t(resultLaplace_100_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_S=norm(model_lasso_100.Ez%*%t(model_lasso_100$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Flat_NS=FNormXhat(resultFlat_10,X,W,Z,Theta,Beta,B),
                Normal_NS=FNormXhat(Normal_10,X,W,Z,Theta,Beta,B,
                                    min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk)),
                MOM_NS=FNormXhat(MOM_10,X,W,Z,Theta,Beta,B,
                                 min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk)),
                COMBAT_NS=norm(COMBAT_10$Z%*%t(COMBAT_10$Gamma)-t(COMBAT),type ="F"),
                #FastBFA_S=FNorm(resultLaplace_100_Vl20$Omega,PostML(resultLaplace_100_Vl20),Omega,B),
                FastBFA_NS=norm(resultLaplace_10_Vl20$Omega%*%t(resultLaplace_10_Vl20$B)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"),
                Lasso_NS=norm(model_lasso_10.Ez%*%t(model_lasso_10$loadings)-(X%*%t(B)+W%*%t(Theta)+Z%*%t(Beta)),type ="F"))

Sigma=B%*%t(B)+diag(Tau_inv[,1])+diag(Tau_inv[,2])

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

it=data.frame(Flat_S=resultFlat_100$iterations,
              Normal_S=Normal_100$iterations,
              MOM_S=MOM_100$iterations,
              COMBAT_S=COMBAT_100$niter,
              FastBFA_S=(resultLaplace_100_Vl5$niter+resultLaplace_100_Vl10$niter+resultLaplace_100_Vl10$niter),
              Lasso_S=0,
              Flat_NS=resultFlat_10$iterations,
              Normal_NS=Normal_10$iterations,
              MOM_NS=MOM_10$iterations,
              COMBAT_NS=COMBAT_10$niter,
              FastBFA_NS=(resultLaplace_10_Vl5$niter+resultLaplace_10_Vl10$niter+resultLaplace_10_Vl10$niter),
              Lasso_NS=0)

tableFN2=rbind.data.frame(q_hat=q.hat.2,Mhat=m.hat.2,FN_ZM2=FN.2,FN_X=FN.x,FN_covX=FN2,it=it)
round(t(tableFN2),1)
write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset10.RData")

####FIXING TABLE####
######Fix######
######250######
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset01.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset02.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset03.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset04.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset05.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset06.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset07.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset08.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset09.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p250q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p250q10BEDataset10.RData")

####5000####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset01.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset02.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset03.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset04.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset05.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset06.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset07.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset08.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset09.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809FixMn100p500q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806FixMn100p500q10BEDataset10.RData")

######Sparse######
######250######
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset01.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset02.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset03.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset04.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset05.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset06.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset07.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset08.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset09.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p250q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p250q10BEDataset10.RData")

####500####
####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset01.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset01")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset01.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset02.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset02")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset02.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset03.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset03")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset03.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset04.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset04")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset04.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset05.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset05")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset05.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset06.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset06")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset06.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset07.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset07")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset07.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset08.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset08")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset08.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset09.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset09")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset09.RData")

####1####
rm(list=ls())
load("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset10.RData")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.CV.V1.R")
source("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/BE.BFA.EM/R/BFA.EM.BE.FUN.CV.V1.R")
library(mvtnorm)
library(partitions)
library(nloptr)
library(glmnet)
require(MASS)
require(psych)
require(matrixcalc)
require(Matrix)
require(plyr)
require(LaplacesDemon)
require(mnormt)
require(animation)
require(PMA)
require(sva)
require(cate)
library(fanc)

FN2=data.frame(Flat_S=FNorm2BE(resultFlat_100$sigma,resultFlat_100$M,Sigma),
               Normal_S=ifelse(min(fnNormal100nr,fnNormal100r)<=min(fnNormal100nrjk,fnNormal100rjk),
                               FNorm2BE(Normal_100$sigma,PostM2(Normal_100),Sigma),
                               FNorm2BE(Normal_100$sigma,PostM(Normal_100),Sigma)),
               MOM_S=ifelse(min(fnMOM100nr,fnMOM100r)<=min(fnMOM100nrjk,fnMOM100rjk),
                            FNorm2BE(MOM_100$sigma,PostM2(MOM_100),Sigma),
                            FNorm2BE(MOM_100$sigma,PostM(MOM_100),Sigma)),
               COMBAT_S=FNorm2BE(COMBAT_100$Sigma,COMBAT_100$Gamma,Sigma),
               FastBFA_S=FNorm2BE(resultLaplace_100_Vl20$sigma,resultLaplace_100_Vl20$B,Sigma),
               Lasso_S=FNorm2BE(model_lasso_100$uniquenesses,model_lasso_100$loadings,Sigma),
               Flat_NS=FNorm2BE(resultFlat_10$sigma,resultFlat_10$M,Sigma),
               Normal_NS=ifelse(min(fnNormal10nr,fnNormal10r)<=min(fnNormal10nrjk,fnNormal10rjk),
                                FNorm2BE(Normal_10$sigma,PostM2(Normal_10),Sigma),
                                FNorm2BE(Normal_10$sigma,PostM(Normal_10),Sigma)),
               MOM_NS=ifelse(min(fnMOM10nr,fnMOM10r)<=min(fnMOM10nrjk,fnMOM10rjk),
                             FNorm2BE(MOM_10$sigma,PostM2(MOM_10),Sigma),
                             FNorm2BE(MOM_10$sigma,PostM(MOM_10),Sigma)),
               COMBAT_NS=FNorm2BE(COMBAT_10$Sigma,COMBAT_10$Gamma,Sigma),
               FastBFA_NS=FNorm2BE(resultLaplace_10_Vl20$sigma,resultLaplace_10_Vl20$B,Sigma),
               Lasso_NS=FNorm2BE(model_lasso_10$uniquenesses,model_lasso_10$loadings,Sigma))

write.csv(round(t(tableFN2),1), file = "/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/Table1809SparseMn100p500q10BEDataset10")
save.image("/Users/alejandraavalospacheco/Dropbox/OxWaSP/Programing/BFA/Examples/Paper1806/1806SparseMn100p500q10BEDataset10.RData")
